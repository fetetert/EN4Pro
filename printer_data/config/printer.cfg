  ##############################################################################
#----------------------------------------------------------------------------#
#      ____                _  __         __  ____                            #
#     / __ \___  ___ ___  / |/ /__ ___  / /_/ / /__ _____  ___               #
#    / /_/ / _ \/ -_) _ \/    / -_) _ \/ __/_  _/ // / _ \/ -_)              #
#    \____/ .__/\__/_//_/_/|_/\__/ .__/\__/ /_/ \_,_/_//_/\__/               #
#        /_/                    /_/                                          #
#----------------------------------------------------------------------------#
;   Neptune 4 Series Custom Image by (OpenNeptune3D/OpenNept4une):
#----------------------------------------------------------------------------#
; Wiki    : https://github.com/OpenNeptune3D/OpenNept4une/wiki
; Discord : https://discord.com/invite/X6kwchT6WM

#############################################################################
#   External Config Includes
#############################################################################

#[include mainsail.cfg]                 ; Mainsail runs on port 81 (http://IP_ADDRESS:81)
[include timelapse.cfg]                ; Timelapse config
#[include fluidd.cfg]                   ; Fluidd Macros
[include KAMP_Settings.cfg]            ; Klipper Adaptive Mesh and Purge config
[include moonraker_obico_macros.cfg]   ; Moonraker config and updates

[include ./Macros/print_start.cfg]              ; Custom Print Start 
[include ./Macros/print_end.cfg]                ; Custom Print End 
[include ./Macros/printing_macros.cfg]          ; Custom Cancel, Resume etc
[include ./Macros/user_settings.cfg]            ; Custom Temperature settings etc
[include shell_command.cfg]                     ; Users custom macros

#[include adxl.cfg]                     ; Comment this out when you disconnect the Pico

#[include klipper_debug.cfg]            ; Klipper Debug Config

#############################################################################
#   Base Config
#############################################################################

[mcu]
serial: /dev/ttyS0 ; The hardware use USART1 PA10/PA9 connect to RK3328
baud: 250000
restart_method: command

[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_5044506130603D1C-if00   ; This is the serial address of your eddy probe. This can be found by using the terminal of your klipper instance (typically through SSH) and using the command ```ls /dev/serial/by-id``` 
restart_method: command

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu # Sets the type of sensor for Klipper to read
sensor_mcu: eddy # Sets the MCU of the eddy probe tempereature sensor
min_temp: 10 # Sets the minimum tempereature for eddys tempereature sensor to operate
max_temp: 100 # Sets the maximum tempereature for eddys tempereature sensor to operate

[printer]
kinematics:cartesian
#max_velocity: 250
max_velocity: 500
max_accel: 7000
#max_accel: 3000
max_z_velocity: 8
max_z_accel: 120
square_corner_velocity: 5.0
minimum_cruise_ratio: 0.0

[respond]
[gcode_arcs]
[pause_resume]
[display_status]
[exclude_object]
[firmware_retraction]
[virtual_sdcard]
path: /home/mks/printer_data/gcodes
on_error_gcode: CANCEL_PRINT
[force_move]
enable_force_move : True
[idle_timeout]
timeout: 2100                  ; 35min idle timeout (when not paused or printing)

#############################################################################
#   X/Y/Z Stepper Config
#############################################################################

[stepper_x]
step_pin: PC14
dir_pin: PC13
enable_pin: !PC15
microsteps: 16
rotation_distance: 40
full_steps_per_rotation:200                  ; set to 400 for 0.9 degree stepper
endstop_pin: PC0
position_min: -6.5
position_endstop: -6.5
position_max: 242
homing_speed: 50
homing_retract_dist: 5
homing_positive_dir: false

[stepper_y]
step_pin: PB4
dir_pin: PB3
enable_pin: !PB5
microsteps: 16
rotation_distance: 40
full_steps_per_rotation:200                  ; set to 400 for 0.9 degree stepper
endstop_pin: PB8
position_min: -2
position_endstop: -2
position_max: 235
homing_speed:50
homing_retract_dist: 5
homing_positive_dir: false

[stepper_z]
step_pin: PC10
dir_pin: !PA15
enable_pin: !PC11
microsteps: 32
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin:probe:z_virtual_endstop
position_max: 268
position_min: -2
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 5

[stepper_z1]
step_pin: PB1
dir_pin: PB2
enable_pin: !PB0
microsteps: 32
rotation_distance: 8

#############################################################################
#   TMC Stepper-driver UART Config
#############################################################################

[tmc2209 stepper_x]
uart_pin: PB9
run_current: 1.2
#interpolate: false
interpolate: True
stealthchop_threshold: 0
#stealthchop_threshold: 999999

[tmc2209 stepper_y]
uart_pin: PD2
run_current: 1.2
#interpolate: false
interpolate: True
stealthchop_threshold: 0
#stealthchop_threshold: 999999

[tmc2209 stepper_z]
uart_pin: PC5
run_current: 0.8
interpolate: True
sense_resistor: 0.11
stealthchop_threshold: 0
#stealthchop_threshold: 999999

[tmc2209 stepper_z1]
uart_pin: PB6
run_current: 0.8
interpolate: True
sense_resistor: 0.11
stealthchop_threshold: 0
#stealthchop_threshold: 999999

[tmc2209 extruder]
uart_pin: PC4
run_current: 0.9
#interpolate: false
interpolate: True
stealthchop_threshold: 0
#stealthchop_threshold: 999999

#############################################################################
#   Extruder Config
#############################################################################

[extruder]
step_pin:PA5
dir_pin:!PA6
enable_pin:!PA4
microsteps: 32
rotation_distance: 28.59912                    ; 31.4 Bondtech 5mm Drive Gears
#rotation_distance: 28.888                     ; 31.4 Bondtech 5mm Drive Gears
gear_ratio: 52:10
full_steps_per_rotation: 200                   ; 200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: 0
max_temp: 330
heater_pin: PA7
sensor_type:NTC 100K MGB18-104F39050L32
sensor_pin: PA1
max_power: 1
#control = pid
#pid_kp = 25.825
#pid_ki = 1.979
#pid_kd = 84.254
pressure_advance: 0.02725
pressure_advance_smooth_time: 0.02
max_extrude_cross_section: 5                  ; standard klipper default 4* (NozzleDiam^2)
instantaneous_corner_velocity: 5.0
max_extrude_only_distance: 101
max_extrude_only_velocity:45
max_extrude_only_accel:2000
step_pulse_duration:0.000002

[verify_heater extruder]
max_error: 120
check_gain_time: 30
hysteresis: 10
heating_gain: 2

#############################################################################
#   Bed Heater Config
#############################################################################

[heater_bed]
heater_pin:PB10
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA0
max_power: 1.0
#control = pid
#pid_kp = 68.601
#pid_ki = 1.550
#pid_kd = 758.895
min_temp: 0
max_temp: 120 
pwm_cycle_time: 0.3

[verify_heater heater_bed]
max_error: 120
check_gain_time: 180
hysteresis: 10
heating_gain: 1

#####################################################################
#   Outer Bed Heater Config
#####################################################################

[heater_generic heater_bed_outer]
heater_pin:PC8
max_power:1.0
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin:PC2
#control = pid
#pid_kp = 75.301
#pid_ki = 1.383
#pid_kd = 1025.032
min_temp:0
max_temp:120
pwm_cycle_time: 0.3

[verify_heater heater_bed_outer]    ; heating bed temperature tolerance configuration
max_error: 600                      ; maximum error
check_gain_time:180                 ; tolerance time
hysteresis: 10                      ; tolerance temperature
heating_gain: 1                     ; heating gain

#####################################################################
#   Bed Heater Macros
#####################################################################

[gcode_macro SET_BED_TEMPERATURE]   ; macros for innner & outer bed temperature depending on the print size
gcode:
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={params.TARGET}
    {% if not printer["gcode_macro PRINT_START"].small_print %}
      SET_HEATER_TEMPERATURE HEATER=heater_bed_outer TARGET={params.TARGET}
    {% endif %}

[gcode_macro BED_TEMPERATURE_WAIT]
gcode:
    {% if params.MINIMUM is defined and params.MAXIMUM is defined %}
      TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={params.MINIMUM} MAXIMUM={params.MAXIMUM}
      {% if not printer["gcode_macro PRINT_START"].small_print %}
        TEMPERATURE_WAIT SENSOR="heater_generic heater_bed_outer" MINIMUM={params.MINIMUM} MAXIMUM={params.MAXIMUM}
      {% endif %}
    {% elif params.MINIMUM is defined %}
      TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={params.MINIMUM}
      {% if not printer["gcode_macro PRINT_START"].small_print %}
        TEMPERATURE_WAIT SENSOR="heater_generic heater_bed_outer" MINIMUM={params.MINIMUM}
      {% endif %}
    {% elif params.MAXIMUM is defined %}
      TEMPERATURE_WAIT SENSOR=heater_bed MAXIMUM={params.MAXIMUM}
      {% if not printer["gcode_macro PRINT_START"].small_print %}
        TEMPERATURE_WAIT SENSOR="heater_generic heater_bed_outer" MAXIMUM={params.MAXIMUM}
      {% endif %}
    {% else %}
      RESPOND TYPE=error MSG="Error on 'BED_TEMPERATURE_WAIT': missing MINIMUM or MAXIMUM."
    {% endif %}

#############################################################################
#   Probe Config
#############################################################################

#[probe]
#pin:^PA11
##x_offset: -23.9                ;factory print head
##y_offset: 19                   ;factory print head
#x_offset: -24.7                 ;modded print head
#y_offset: 22                    ;modded print head
##z_offset = 0
#speed: 10.0
#samples: 5
#samples_result: median 
#sample_retract_dist: 3.0
#samples_tolerance: 0.05
#samples_tolerance_retries: 5

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
#z_offset: 2.0
# z_offset: 2.5
#i2c_address:
i2c_mcu: eddy  # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the MCU you have used.
i2c_bus: i2c0f # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the I2C bus you have used.
#BTT Eddy w/o case
x_offset: -21.6 ; Measure the offsets below using the method described here: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-x-and-y-offsets
y_offset: 25    ; Measure the offsets below using the method described here: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-x-and-y-offsets
#y_offset: 26.4  ; Measure the offsets below using the method described here: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-x-and-y-offsets
#BTT Eddy w/ case
# x_offset: -36.3 ; Measure the offsets below using the method described here: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-x-and-y-offsets
# y_offset: 34    ; Measure the offsets below using the method described here: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-x-and-y-offsets

# This section is only relevant for Eddy USB. Comment it out for Eddy Coil.
[temperature_sensor btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26
#horizontal_move_z: 2

[bed_mesh]
horizontal_move_z: 2.5
speed: 400
# For the mesh dimensions below, the coordinates need to be reachable by the center of the probe. To calculate coordinates that will work, use the formula below:
# mesh x min = position_min_x + greater_of (15mm or x_offset) <--- in this term, only consider the x offset if it is positive, ignore if negative.
# mesh y min = position_min_y + greater_of (15mm or y_offset) <--- in this term, only consider the y offset if it is positive, ignore if negative.
# mesh x max = position_max_x - greater_of (15mm or |x_offset|) <--- in this term, only consider the x offset if it is negative, ignore if positive.
# mesh y max = position_max_y - greater_of (15mm or |y_offset|) <--- in this term, only consider the y offset if it is negative, ignore if positive.
# Example: Consider that you have a 300 x 300 bed with the max x and y positions being 300 and the min being 0. Your probe offsets are -20 for X and 10 for Y
# For mesh x min we ignore the x offset term because it is negative. Therefore mesh x min = 15
# For mesh y min we do not ignore the y offset term because it is positive but it is less than 15 so we use 15. Therefore mesh y min = 15
# For mesh x max we do not ignore the x offset term because it is negative. It is also greater than 15. Therefore mesh x max = 280
# For mesh y max we ignore the y offset term because it is positive but it is less than 15 so we use 15. Therefore mesh y max = 285
# The final result would be mesh_min: 15, 15 mesh_max: 280, 285
# mesh_min: 10, 32 
#mesh_min: 15, 32  # eddy with case # modify these according to the above guide. If the probe cannot reach then you will get a klipper error when trying to scan a bed mesh.
#mesh_max: 205, 220 # eddy with case # modify these according to the above guide. If the probe cannot reach then you will get a klipper error when trying to scan a bed mesh.
mesh_min: 15, 26.4  # modify these according to the above guide. If the probe cannot reach then you will get a klipper error when trying to scan a bed mesh.
mesh_max: 212.4, 219 # modify these according to the above guide. If the probe cannot reach then you will get a klipper error when trying to scan a bed mesh.
probe_count: 9, 9
algorithm: bicubic
#scan_overshoot: 8  #uncomment this section if you still have room left over on the X axis for some scan overshoot to product smoother movements and more accurate scanning. Uncommenting this should be fine if you are using a standard voron mount.

#[bed_mesh]
#speed:500
#horizontal_move_z: 5
#mesh_min: 10,21
#mesh_max: 210,211
#probe_count:12,12
## probe_count:11,11
#algorithm:bicubic
#bicubic_tension:0.2
#mesh_pps: 2,2
## mesh_pps: 4,4
#fade_start: 1
#fade_end: 0
## fade_end: 10
#adaptive_margin: 5

#############################################################################
#   LED Config
#############################################################################

[output_pin Frame_Light]
pin: PB7

[output_pin Part_Light]
pin: PC7

[gcode_macro Frame_Light_ON]
gcode:
  SET_PIN PIN=Frame_Light VALUE=1

[gcode_macro Frame_Light_OFF]
gcode:
  SET_PIN PIN=Frame_Light VALUE=0

[gcode_macro Part_Light_ON]
gcode:
  SET_PIN PIN=Part_Light VALUE=1

[gcode_macro Part_Light_OFF]
gcode:
  SET_PIN PIN=Part_Light VALUE=0




#############################################################################
#   Beeper Config
#############################################################################

[pwm_cycle_time beeper]
pin: PA2
value: 0
shutdown_value: 0
cycle_time: 0.0005                                  ; Default PWM frequency: 2 kHz

[gcode_macro M300]
gcode:
    {% set S = params.S|default(2000)|int %}        ; Set frequency (S), default to 2 kHz if omitted or invalid
    {% set P = params.P|default(100)|int %}         ; Set duration (P), default to 100ms if omitted or invalid
    SET_PIN PIN=beeper VALUE=0.8 CYCLE_TIME={ 1.0/S if S > 0 else 1 }       ; Activate the beeper at a 80% duty cycle
    G4 P{P}                                         ; Hold the beep for the specified duration
    SET_PIN PIN=beeper VALUE=0                      ; Turn off the beeper

[gcode_macro PAUSE_TUNE]
gcode:
    SET_PIN PIN=beeper VALUE=0.8 CYCLE_TIME={ 1.0/784 }       ; Activate the beeper at a 80% duty cycle
    G4 P300                                         ; Hold the beep for the specified duration
    SET_PIN PIN=beeper VALUE=0.8 CYCLE_TIME={ 1.0/587 }       ; Activate the beeper at a 80% duty cycle
    G4 P600                                         ; Hold the beep for the specified duration
    SET_PIN PIN=beeper VALUE=0                      ; Turn off the beeper

#############################################################################
#   Fan & Temp Monitoring Config
#############################################################################

[fan]
pin: PC9

[controller_fan heatbreak+mainboard_fan]
pin: PA8
fan_speed: 0.5
idle_speed: 0.5
idle_timeout: 43200                                     ; 50% speed for 12h then OFF
shutdown_speed: 1
heater: extruder, heater_bed, heater_bed_outer
stepper: stepper_x, stepper_y, stepper_z, stepper_z1, extruder

[delayed_gcode start_fan_at_idle_speed]
initial_duration: 5.                                ; 5s wait after boot
gcode:
  # Gcode Hack to trigger the mainboard fan from printer boot
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=1 ; bed heat to 1degC
  G4 P2000                                          ; wait 2s
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0 ; bed heat off

[temperature_sensor RockchipHost]
sensor_type: temperature_host
min_temp: 10
max_temp: 80

[temperature_sensor STM32MCU]
sensor_type: temperature_mcu
min_temp: 10
max_temp: 85



#############################################################################
#   Filament Sensor & Change Macros
#############################################################################

[filament_switch_sensor filament_sensor]
pause_on_runout: True
insert_gcode:
    M117 Insert Detected
runout_gcode:
    M117 Runout Detected
    UNLOAD_FILAMENT
event_delay: 3.0
pause_delay: 1.0
switch_pin: PA12

[delayed_gcode DISABLE_FILAMENT_SENSOR]
initial_duration: 1
gcode:
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  25
variable_purge_distance:  30
gcode:
#  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=200
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={200-4} # MAXIMUM={200+40}
  {% set speed = params.SPEED|default(300) %}
  {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 30 %}
  SAVE_GCODE_STATE NAME=load_state
  G91
  G92 E0
  G1 E{load_distance} F{max_velocity}          ; fast-load
  G1 E{purge_distance} F{speed}                ; purge
  RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  55
variable_purge_distance:  15
gcode:
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=200
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={200-4} MAXIMUM={200+40}
  {% set speed = params.SPEED|default(300) %}
  {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 30 %}
  SAVE_GCODE_STATE NAME=unload_state
  G91
  G92 E0
  G1 E{purge_distance} F{speed}                ; purge
  G1 E-{unload_distance} F{max_velocity}       ; fast-unload
  RESTORE_GCODE_STATE NAME=unload_state

#############################################################################
#   Homing & Levelling Config/Macros
#############################################################################
[gcode_macro G28]
rename_existing: G28.1
gcode:
  G28.1 {rawparams}
  {% if not rawparams or (rawparams and 'Z' in rawparams) %}
    PROBE
    SET_Z_FROM_PROBE
  {% endif %}

[gcode_macro LOAD_CURRENT_MESH]
description: Load the current mesh
gcode:
    BED_MESH_PROFILE LOAD=default


[safe_z_home]
#home_xy_position: 141.75, 97.05
home_xy_position: 144, 100
speed: 200
z_hop: 10
z_hop_speed: 25

[axis_twist_compensation]
calibrate_start_x: 30
calibrate_end_x: 210
calibrate_y: 117.5

[gcode_macro Axis_Twist_Comp_Tune]
gcode:    
      G28
      AXIS_TWIST_COMPENSATION_CALIBRATE

[screws_tilt_adjust]
screw1: 141.75, 97.05  
screw1_name: center (base)
screw2: 56.75, 182.05  
screw2_name: rear left screw
screw3: 56.75, 12.05  
screw3_name: front left screw
screw4: 226.75, 12.05  
screw4_name: front right screw
screw5: 226.75, 182.05  
screw5_name: rear right screw
horizontal_move_z: 3
#speed: 150
screw_thread: CW-M3

[gcode_macro Bed_Level_Screws_Tune]
gcode:
      BED_MESH_CLEAR
#      SET_BED_TEMPERATURE TARGET=70
#      BED_TEMPERATURE_WAIT MINIMUM=65 MAXIMUM=75
      G28
      SCREWS_TILT_CALCULATE

[z_tilt]
z_positions:
        56.75, 115
        226.75, 115
points:
        56.75, 115
        226.75, 115
speed: 300
horizontal_move_z: 3
retries: 15
retry_tolerance: .0025

#[gcode_macro Z_Axis_Adjust]
#description: Compensate for Z axis tilt
#gcode:
##     SET_BED_TEMPERATURE TARGET=70
##      BED_TEMPERATURE_WAIT MINIMUM=60 MAXIMUM=75
#      G28
#      Z_TILT_ADJUST

[gcode_macro _Z_TILT_MAYBE]
gcode:
  {% if printer["gcode_macro Z_TILT_ADJUST"].adjusted != 1 %}
    Z_TILT_ADJUST
  {% else %}
    {action_respond_info("Z tilt already adjusted, skipping.")} 
  {% endif %}

[gcode_macro Z_TILT_ADJUST]
rename_existing: OG_Z_TILT_ADJUST
variable_adjusted: 0
gcode:
  OG_Z_TILT_ADJUST
  G28 Z
  SET_GCODE_VARIABLE MACRO=Z_TILT_ADJUST VARIABLE=adjusted VALUE=1

[gcode_macro M18]
rename_existing: M1800
gcode:
  M1800 {rawparams}
  SET_GCODE_VARIABLE MACRO=Z_TILT_ADJUST VARIABLE=adjusted VALUE=0

[gcode_macro M84]
rename_existing: M8400
gcode:
  M8400 {rawparams}
  SET_GCODE_VARIABLE MACRO=Z_TILT_ADJUST VARIABLE=adjusted VALUE=0

[gcode_macro SET_Z_FROM_PROBE]
gcode:
    {% set cf = printer.configfile.settings %}
    SET_GCODE_OFFSET_ORIG Z={printer.probe.last_z_result - cf['probe_eddy_current btt_eddy'].z_offset + printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset}
    G90
    G1 Z{cf.safe_z_home.z_hop}

[gcode_macro SET_GCODE_OFFSET]
rename_existing: SET_GCODE_OFFSET_ORIG
variable_restored: False  # Mark whether the var has been restored from NVM
variable_runtime_offset: 0
gcode:
#  {% if params.Z_ADJUST %}
#    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset + params.Z_ADJUST|float }
#  {% endif %}
#  {% if params.Z %}
#    {% set paramList = rawparams.split() %}
#    {% for i in range(paramList|length) %}
#      {% if paramList[i]=="Z=0" %}
#        {% set temp=paramList.pop(i) %}
#        {% set temp="Z_ADJUST=" + (-printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset)|string %}
#        {% if paramList.append(temp) %}{% endif %}
#      {% endif %}
#    {% endfor %}
#    {% set rawparams=paramList|join(' ') %}
#    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE=0
#  {% endif %}
  SET_GCODE_OFFSET_ORIG { rawparams }

#[gcode_macro Calibrate_Probe_Z_Offset]
#gcode:
#      G28
#      PROBE_CALIBRATE

# This macro automates a lot of the frequency mapping process and simplifies the steps significantly.
[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
gcode:
  BED_MESH_CLEAR
  G28 X Y
  G90 # Abs positioning
  G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
  {% if 'z' not in printer.toolhead.homed_axes %}
    SET_KINEMATIC_POSITION Z={ printer.toolhead.axis_maximum.z-1 } # Allows the user to work it down until it touches.
  {% endif %}
  PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy #{rawparams}

#This macro is optional but useful if you want to run a rapid scan before each print. Simply uncomment it and add BED_MESH_SCAN to your print start code.
#[gcode_macro BED_MESH_CALIBRATE]
#rename_existing: BTT_BED_MESH_CALIBRATE
#gcode:
#  BTT_BED_MESH_CALIBRATE METHOD=rapid_scan

[gcode_macro Auto_Full_Bed_Level]
gcode:
      RESPOND PREFIX="info" MSG="Running Custom Bed Leveling Macro"
      BED_MESH_CLEAR
      SET_BED_TEMPERATURE TARGET=70
      BED_TEMPERATURE_WAIT MINIMUM=67 MAXIMUM=73
#      G28
      BED_MESH_CALIBRATE

#############################################################################
#   PID Tuning Macros
#############################################################################

[gcode_macro PID_Tune_EXTRUDER]
gcode:
  {% set temperature = params.TEMPERATURE|default(210) %}
  G28
#  M106 S255 ;Sets Print Fans to 100%
  M106 S128 ;Sets Print Fans to 50%
  PID_CALIBRATE HEATER=extruder TARGET={temperature}
  SAVE_CONFIG

[gcode_macro PID_Tune_BED]
gcode:
  {% set temperature = params.TEMPERATURE|default(60) %}
  G28
#  M106 S255 ;Sets Print Fans to 100%
  M106 S128 ;Sets Print Fans to 50%
  PID_CALIBRATE HEATER=heater_bed TARGET={temperature}
  SAVE_CONFIG
  
[gcode_macro PID_Tune_Outer_BED]
gcode:
  {% set temperature = params.TEMPERATURE|default(60) %}
  G28
#  M106 S255 ;Sets Print Fans to 100%
  M106 S128 ;Sets Print Fans to 50%
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={temperature} 	;Heats Inner Zone at the same time for better tuning 
  PID_CALIBRATE HEATER=heater_bed_outer TARGET={temperature}
  SAVE_CONFIG

#############################################################################
#   Input Shaper Config
#############################################################################

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 62.8
shaper_type_y = mzv
shaper_freq_y = 42.4

#############################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 23.296
#*# pid_ki = 1.284
#*# pid_kd = 105.705
#*# pid_version = 1
#*# pid_target = 210.00
#*# pid_tolerance = 0.0200
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 68.684
#*# pid_ki = 1.948
#*# pid_kd = 605.274
#*# pid_version = 1
#*# pid_target = 60.00
#*# pid_tolerance = 0.0200
#*#
#*# [heater_generic heater_bed_outer]
#*# control = pid
#*# pid_kp = 73.849
#*# pid_ki = 1.368
#*# pid_kd = 996.963
#*#
#*# [axis_twist_compensation]
#*# z_compensations = 0.034415, -0.034321, -0.000094
#*# compensation_start_x = 30.0
#*# compensation_end_x = 210.0
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3269278.124,0.090000:3268576.405,0.130000:3267859.320,
#*# 	0.170000:3267139.140,0.210000:3266448.428,0.250000:3265782.360,
#*# 	0.290000:3265100.643,0.330000:3264425.979,0.370000:3263775.112,
#*# 	0.410000:3263133.681,0.450000:3262472.057,0.490000:3261845.298,
#*# 	0.530000:3261246.534,0.570000:3260615.608,0.610000:3260047.798,
#*# 	0.650000:3259453.534,0.690000:3258884.924,0.730000:3258282.142,
#*# 	0.770000:3257766.032,0.810000:3257202.959,0.850000:3256637.977,
#*# 	0.890000:3256131.924,0.930000:3255610.752,0.970000:3255088.749,
#*# 	1.010000:3254564.813,1.050000:3254077.354,1.090000:3253599.785,
#*# 	1.130000:3253116.660,1.170000:3252612.700,1.210000:3252151.582,
#*# 	1.250000:3251696.838,1.290000:3251260.330,1.330000:3250819.053,
#*# 	1.370000:3250382.619,1.410000:3249973.193,1.450000:3249563.592,
#*# 	1.490000:3249158.349,1.530000:3248735.381,1.570000:3248358.126,
#*# 	1.610000:3247956.423,1.650000:3247553.075,1.690000:3247161.817,
#*# 	1.730000:3246814.240,1.770000:3246454.892,1.810000:3246069.068,
#*# 	1.850000:3245754.305,1.890000:3245406.704,1.930000:3245048.752,
#*# 	1.970000:3244727.847,2.010000:3244379.534,2.050000:3244064.337,
#*# 	2.090000:3243730.923,2.130000:3243418.071,2.170000:3243122.727,
#*# 	2.210000:3242844.954,2.250000:3242502.610,2.290000:3242233.690,
#*# 	2.330000:3241930.355,2.370000:3241660.372,2.410000:3241331.411,
#*# 	2.450000:3241086.440,2.490000:3240839.848,2.530000:3240572.623,
#*# 	2.570000:3240302.918,2.610000:3240041.181,2.650000:3239799.673,
#*# 	2.690000:3239552.269,2.730000:3239301.728,2.770000:3239067.879,
#*# 	2.810000:3238838.035,2.850000:3238597.945,2.890000:3238383.524,
#*# 	2.930000:3238160.331,2.970000:3237935.036,3.010000:3237734.323,
#*# 	3.050000:3237528.037,3.090000:3237296.528,3.130000:3237081.340,
#*# 	3.170000:3236894.356,3.210000:3236688.744,3.250000:3236500.284,
#*# 	3.290000:3236293.812,3.330000:3236117.991,3.370000:3235935.592,
#*# 	3.410000:3235737.820,3.450000:3235562.202,3.490000:3235400.501,
#*# 	3.530000:3235198.060,3.570000:3235048.758,3.610000:3234860.610,
#*# 	3.650000:3234696.901,3.690000:3234534.141,3.730000:3234367.870,
#*# 	3.770000:3234195.612,3.810000:3234039.642,3.850000:3233875.183,
#*# 	3.890000:3233736.037,3.930000:3233591.843,3.970000:3233422.823,
#*# 	4.010000:3233286.163,4.050000:3233127.274
#*# z_offset = 2.200
#*#
#*# [heater_bed_outer]
#*# pid_version = 1
#*# pid_target = 60.00
#*# pid_tolerance = 0.0200
#*# control = pid
#*# pid_kp = 73.755
#*# pid_ki = 1.374
#*# pid_kd = 989.544
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.286823, -0.279078, -0.268360, -0.261146, -0.256967, -0.255567, -0.252259, -0.263635, -0.261675
#*# 	-0.301110, -0.315904, -0.335776, -0.331975, -0.324338, -0.310118, -0.312582, -0.316014, -0.323852
#*# 	-0.288633, -0.314516, -0.337587, -0.335613, -0.325127, -0.306552, -0.304033, -0.310138, -0.300595
#*# 	-0.296323, -0.306170, -0.322659, -0.310043, -0.297672, -0.301404, -0.307525, -0.296309, -0.275335
#*# 	-0.308348, -0.310195, -0.320949, -0.315015, -0.302507, -0.305083, -0.321676, -0.306352, -0.273225
#*# 	-0.286730, -0.285510, -0.300429, -0.299032, -0.292655, -0.298514, -0.317907, -0.311106, -0.297367
#*# 	-0.310846, -0.297846, -0.302261, -0.309002, -0.305622, -0.312176, -0.316308, -0.308856, -0.293025
#*# 	-0.350236, -0.314610, -0.298055, -0.302843, -0.295728, -0.295798, -0.301648, -0.295318, -0.290846
#*# 	-0.342316, -0.297369, -0.274594, -0.268822, -0.255860, -0.253202, -0.260054, -0.273139, -0.284849
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 212.36
#*# min_y = 26.4
#*# max_y = 218.95999999999995
